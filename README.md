# 星座API

這是一個用python建立的星座運勢查询網頁API，可以查詢不同星座每日運勢。

## 功能特點

- 提供繁體中文星座運勢查詢
- 支持繁體轉簡體中文功能
- 提供HTML和JSON兩種格式的API
- 實現數據緩存機制，減少對源站的請求次數
- 兼容原有的API調用方式
- 支持WSGI部署
- **新增**: 定時爬取更新功能（每天早上8點和晚上8點）
- **新增**: 應用啟動時自動更新所有星座數據

## 安裝

### 步驟

1. 安裝Python (3.6以上版本)
2. 安裝依賴包
   ```sh 
   pip install -r requirements.txt
   ```

### 必要庫

- flask: Web框架
- bs4 (Beautiful Soup): HTML解析
- requests: HTTP請求
- gunicorn: WSGI服務器（部署用）
- opencc-python-reimplemented: 繁簡體中文轉換
- apscheduler: 定時任務調度器

## 使用方法

### 啟動服務

開發環境:
```sh
python astro_api.py
```

生產環境:
```sh 
gunicorn --workers=2 --bind=0.0.0.0:5000 wsgi:app
```

啟動後系統會：
1. 立即爬取所有12個星座的最新運勢數據
2. 設置定時任務，在每天早8點和晚8點自動檢查和更新數據

### HTML格式API (原有格式)

網址部分輸入:
```
http://127.0.0.1:5000/astro_api?num=[星座編號]
```

#### 繁體轉簡體

要將輸出轉換為簡體中文，可以使用 `convert` 參數：
```
http://127.0.0.1:5000/astro_api?num=[星座編號]&convert=true
```

### JSON格式API (新增格式)

網址部分輸入:
```
http://127.0.0.1:5000/api/astro/[星座編號]
```

#### 繁體轉簡體

同樣支援簡體中文轉換:
```
http://127.0.0.1:5000/api/astro/[星座編號]?convert=true
```

### 手動觸發數據更新

如果需要立即更新所有星座數據，可以訪問：
```
http://127.0.0.1:5000/api/update
```

## 星座編號對照表

|星座編號|星座|星座編號|星座|
|---|---|---|---|
|0|牡羊|6|天秤|
|1|金牛|7|天蠍|
|2|雙子|8|射手|
|3|巨蟹|9|魔羯|
|4|獅子|10|水瓶|
|5|處女|11|雙魚|

## 輸出示例

### HTML輸出格式
```
今日金牛座解析
整體運勢★★☆☆☆：
今天桃花旺盛，出門易邂逅美滿愛情，彼此欣賞，情愫漸生。理財上你顯得漫不經心，即使有好的機會，也會很容易錯過。工作方面，你的心緒似乎沒有放在這上面，迷迷糊糊很容易發生一些不該有的錯誤。
愛情運勢★★★☆☆：
對另一半的包容度下降，易因小事而爭吵；單身者易受感情困擾，你愛的人不愛你。
事業運勢★★☆☆☆：
叛逆心較嚴重，喜歡獨立思考，卻不樂意接受他人幫助，對別人的指指點點，哪怕是善意忠告也會很反感。
財運運勢★★☆☆☆：
財運不佳，不宜投機，應把心思放在工作上，付出勞動才有收獲。
```

### JSON輸出格式
```json
{
  "title": "今日金牛座解析",
  "items": [
    "整體運勢★★☆☆☆：",
    "今天桃花旺盛，出門易邂逅美滿愛情，彼此欣賞，情愫漸生。理財上你顯得漫不經心，即使有好的機會，也會很容易錯過。工作方面，你的心緒似乎沒有放在這上面，迷迷糊糊很容易發生一些不該有的錯誤。",
    "愛情運勢★★★☆☆：",
    "對另一半的包容度下降，易因小事而爭吵；單身者易受感情困擾，你愛的人不愛你。",
    "事業運勢★★☆☆☆：",
    "叛逆心較嚴重，喜歡獨立思考，卻不樂意接受他人幫助，對別人的指指點點，哪怕是善意忠告也會很反感。",
    "財運運勢★★☆☆☆：",
    "財運不佳，不宜投機，應把心思放在工作上，付出勞動才有收獲。"
  ],
  "date": "2023-06-25",
  "simplified": false
}
```

## 項目結構

```
astro_api/
│
├── astro_api.py      # 主程序文件
├── wsgi.py           # WSGI入口
├── requirements.txt  # 依賴包列表
├── README.md         # 說明文件
├── update_astro_data.py  # 獨立更新腳本
└── astro_cache.json  # 緩存文件（程序運行後生成）
```

## 技術說明

### 緩存機制

- 系統會根據日期自動緩存星座運勢數據
- 同一天內的重複請求會直接使用緩存數據
- 緩存數據保存在項目目錄下的 `astro_cache.json` 文件中
- 當無法連接源站時，會嘗試使用緩存中的數據（即使不是今天的）

### 定時更新機制

- 系統使用APScheduler設置定時任務
- 在每天早上8點和晚上8點自動檢查並更新數據
- 啟動應用時會立即同步更新所有星座數據
- 更新時會先檢查數據是否有變化，只更新變化了的數據，減少不必要的寫入

### 獨立更新腳本

- 提供獨立的`update_astro_data.py`腳本，可以不啓動Web服務即可更新數據
- 適合用於設置系統的Cron作業，與Web服務解耦
- 使用相同的緩存機制，確保數據一致性

### 繁簡轉換

- 使用 OpenCC 進行繁體到簡體的轉換
- 如果未安裝 OpenCC，系統會優雅地回退到僅提供繁體版本

## 參考

[click108星座](http://astro.click108.com.tw/)